@{
    Layout = "~/Views/master.cshtml";
}

<div ng-controller="ctrl-estacio-editar">

    <!-- FILTROS -->
    <div class="row margin-bottom">

        <div class="col-xs-12">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Período</span>
                    <div class="card-header-button card-header-close">
                        <i class="fa fa-close"></i>
                    </div>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                </div>
                <div class="card-body">

                    <!-- Filtros -->
                    <div class="tab-pane active" id="control-sidebar-filters-tab">
                        <!--DATA INCIAL-->
                        <div class="form-group">
                            <label class="control-sidebar-subheading">Data Inicial</label>
                            <div class="input-group date">
                                <div class="input-group-addon">
                                    <i class="fa fa-calendar"></i>
                                </div>
                                <date-picker class="form-control pull-right" placeholder="yyyy-mm-dd" ng-model="filtros.dtini"></date-picker>
                            </div>
                        </div>

                        <!--DATA FINAL-->
                        <div class="form-group">
                            <label class="control-sidebar-subheading">Data Final</label>
                            <div class="input-group date">
                                <div class="input-group-addon">
                                    <i class="fa fa-calendar"></i>
                                </div>
                                <date-picker class="form-control pull-right" placeholder="yyyy-mm-dd" ng-model="filtros.dtfim"></date-picker>
                            </div>
                        </div>


                        <!--BOTÃO-->
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" data-toggle="control-sidebar" ng-click="carregarDashboard()">Carregar Mailing</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--VISÃO DIA-->
    <div class="row margin-bottom">
        <div class="col-xs-12">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Mailing - Diario</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row margin-bottom">
                        <div class="col-xs-3">
                            <small>
                                <input type="button" class="btn btn-secondary" value="{{opcoes.edit? 'Cancelar':'Editar'}}" ng-click="editar()" />
                            </small>
                            <small>
                                <input type="button" class="btn btn-success" value="Salvar" ng-if="opcoes.edit" ng-click="salvar()" />
                            </small>
                        </div>
                    </div>
                    <div class="table">
                        <table class="table table-striped table-bordered" ng-if="dashboard.dia" style="text-align:center">
                            <thead>
                                <tr>
                                    <th style="text-align:center">Data</th>
                                    <th style="text-align:center">Hora</th>
                                    <th style="text-align:center">Mailing</th>
                                </tr>
                            </thead>
                            <tbody id="idtbody">
                                <tr ng-repeat="dia in dashboard.dia">
                                    <td>{{dia.data | date : 'dd/MM/yyyy'}}</td>
                                    <td ng-if="opcoes.edit">
                                        <input type="number" id="idinput" min="0" max="9999999" placeholder="9.999.999" class="form-control" onkeyup="if (this.value > 9999999) { this.value = '9999999';} else if (this.value < 0) {this.value = '0';}" value="{{dia.hora}}" ng-disabled="!opcoes.edit" />
                                    </td>
                                    <td ng-if="opcoes.edit">
                                        <input type="number" id="idinput" min="0" max="9999999" placeholder="9.999.999" class="form-control" onkeyup="if (this.value > 9999999) { this.value = '9999999';} else if (this.value < 0) {this.value = '0';}" value="{{dia.quantidade}}" ng-disabled="!opcoes.edit" />
                                    </td>
                                    <td id="maisuma" ng-if="!opcoes.edit">{{dia.ds_hora}}</td>
                                    <td id="maisuma" ng-if="!opcoes.edit">{{dia.quantidade | number}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>



</div>

<script>
    angular.module('app').controller('ctrl-estacio-editar', function ($scope, $http, $filter, dadosPagina) {
        dadosPagina.titulo = 'Editar';
        dadosPagina.descricao = 'Estacio'

        // filtros iniciais
        $scope.dashFiltros = {};

        $scope.filtros = {
            dtini: $filter('date')(new Date(), "yyyy-MM-dd"),
            dtfim: $filter('date')(new Date(), "yyyy-MM-dd"),
        };

        $scope.dashboard = {};

        $scope.opcoes = {
            edit: false
        };

        // Objeto Mailing
        $scope.mailing = [{
            data: '',
            hora: '',
            quantidade: '',
        }];


        $scope.cadastrarMailing = function () {
            $http({
                method: 'POST',
                url: "/api/estacio/cadmailing",
                data: JSON.stringify($scope.mailing),
            }).then(function success(r) {

                // Objeto Mailing
                $scope.mailing = [{
                    data: '',
                    hora: '',
                    quantidade: '',
                }];


                location.reload();
                $scope.carregarDashboard();

            });

        }

        // obtem filtros do escopo e carrega os dados do dashboard
        $scope.carregarDashboard = function () {


            $http({
                method: 'POST',
                url: "/api/estacio/mailing",
                data: $scope.filtros,
            }).then(function success(r) {
                let data = r.data;
                $scope.dashboard.status = r.status;
                $scope.dashboard.dia = data.Table;

            });

        }

        $scope.editar = function () {
            $scope.opcoes.edit = !$scope.opcoes.edit;
        }

        $scope.salvar = function () {

            $scope.opcoes.edit = !$scope.opcoes.edit;

            let tabela = document.getElementById('idtbody')


            for (let i = 0; i < tabela.rows.length; i++) {

                let dt = $scope.converterData(tabela.children[i].children[0].innerHTML);
                let txt = tabela.children[i].children[1].getElementsByTagName('input').item(0).value;
                let txt2 = tabela.children[i].children[2].getElementsByTagName('input').item(0).value;

                $scope.mailing.push({ data: dt, hora: txt, quantidade: txt2 });

            }


            $scope.cadastrarMailing();

        }


        $scope.carregarDashboard();

        $scope.converterData = function (data) {
            var dia = data.split("/")[0];
            var mes = data.split("/")[1];
            var ano = data.split("/")[2];

            return ano + '-' + ("0" + mes).slice(-2) + '-' + ("0" + dia).slice(-2);
        }
    });

</script>
