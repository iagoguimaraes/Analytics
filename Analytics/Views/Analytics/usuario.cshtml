@{
    Layout = "~/Views/master.cshtml";
}


<div ng-controller="ctrl-usuario">

    <!--BOTAO DE INSERIR USUARIO-->
    <div class="row margin-bottom">
        <div class="col-xs-12 col-sm-6 margin-bottom">
            <button type="button" class="btn btn-default" data-toggle="modal" data-target="#modal-default">
                Inserir Novo Usuário
            </button>
        </div>
    </div>

    <!--LISTA DE USUARIO-->
    <div class="row margin-bottom" ng-if="usuarios">
        <div class="col-xs-12">
            <d-table class="table table-striped table-bordered" style="width:100%" dados="usuarios"></d-table>
        </div>
    </div>

    <!-- MODAL INSERIR-->
    <div class="modal fade" id="modal-default" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title">Inserir Usuário</h4>
                </div>
                <div class="modal-body">

                    <form role="form">
                       
                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" class="form-control" placeholder="Nome Completo" ng-model="usuario.nome"/>
                        </div>

                        <div class="form-group">
                            <label>Login</label>
                            <input type="text" class="form-control" placeholder="usuario.rede" ng-model="usuario.login" />
                        </div>

                        <div class="form-group" ng-if="grupos">
                            <label>Grupo</label>
                            <div>
                                <select2 class="form-control" data-placeholder="Selecione" ng-model="usuario.grupo" dados="grupos" style="width:100%;"></select2>
                            </div>                            
                        </div>

                        <div class="form-group">
                            <label>Cliente: </label>
                            <input type="checkbox" ng-model="usuario.cliente" />
                        </div>

                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" ng-click="inserirUsuario()">Inserir</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

    <!-- MODAL EDITAR-->
    <div class="modal fade" id="modal-edit" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                    <h4 class="modal-title">Editar Usuário</h4>
                </div>
                <div class="modal-body">

                    <form role="form">

                        <input type="hidden" ng-model="editdiario.id_usuario" />

                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" class="form-control" placeholder="Nome Completo" ng-model="editusuario.nome" />
                        </div>

                        <div class="form-group">
                            <label>Login</label>
                            <input type="text" class="form-control" placeholder="usuario.rede" ng-model="editusuario.login" />
                        </div>

                        <div class="form-group" ng-if="grupos">
                            <label>Grupo</label>
                            <div>
                                <select2 id="editusuario-select2" class="form-control" data-placeholder="Selecione" ng-model="editusuario.grupo" dados="grupos" style="width:100%;"></select2>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Cliente: </label>
                            <input type="checkbox" ng-model="editusuario.cliente" />
                        </div>

                        <div class="form-group">
                            <label>Ativo: </label>
                            <input type="checkbox" ng-model="editusuario.ativo" />
                        </div>

                    </form>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal" ng-click="editarUsuario()">Salvar</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>

</div>

<script>
    angular.module('app').controller('ctrl-usuario', function ($scope, $http, $filter, dadosPagina) {
        dadosPagina.titulo = 'Usuários';
        dadosPagina.descricao = ''

        // carregar os usuários
        $scope.carregarUsuarios = function () {
            $http({
                method: 'GET',
                url: "/api/usuario/obter",
            }).then(function success(r) {
                $scope.usuarios = r.data.Table;
            });
        }
        $scope.carregarUsuarios();

        // carregar os grupos
        $http({
            method: 'GET',
            url: "/api/acessogrupo/grupo/consultar",
        }).then(function success(r) {            
            $scope.grupos = r.data.Table.map(g => ({ id_usuario: g.id_grupo, descricao: g.descricao }));
        });

        // INSERIR USUARIO
        $scope.usuario = {
            nome: '',
            login: '',
            grupo: null,
            cliente: false
        }; // objeto para inserir usuario
        $scope.inserirUsuario = function () {
            $http({
                method: 'POST',
                url: "/api/usuario/inserir",
                data: $scope.usuario,
            }).then(function success(r) {
                $scope.usuario = {
                    nome: '',
                    login: '',
                    grupo: null,
                    cliente: false
                };
                $scope.carregarUsuarios();
            });
        }

        // EDITAR USUARIO
        $scope.editusuario = {}; // objeto para editar usuario
        $scope.editarUsuario = function () {
            $http({
                method: 'POST',
                url: "/api/usuario/alterar",
                data: $scope.editusuario,
            }).then(function success(r) {
                $scope.carregarUsuarios();
            });
        }

        // ao clicar em um usuário, carregar modal
        $(document).on('click', '.table tbody tr', function () {
            // obtem o id da usuário para buscar
            let id = $(this).find('td:nth-child(1)').html();

            // consultar dados do usuario
            $http({
                method: 'POST',
                url: "/api/usuario/consultar",
                data: { id_usuario: id }
            }).then(function success(r) {
                $scope.editusuario.id_usuario = r.data.Table[0].id_usuario;
                $scope.editusuario.nome = r.data.Table[0].nome;
                $scope.editusuario.login = r.data.Table[0].login;
                $scope.editusuario.cliente = r.data.Table[0].cliente;
                $scope.editusuario.ativo = r.data.Table[0].ativo;

                let grupos = r.data.Table[0].grupos.split(',');
                $scope.editusuario.grupo = JSON.stringify(grupos.map(g => ({ id: g })));
                $('#editusuario-select2').val(grupos).trigger('change.select2');

                $('#modal-edit').modal('show');
            });

        });

    });
</script>

<style>
    .table tbody tr{
        cursor: pointer;
    }

    .table tbody tr:hover{
        font-weight: bold;
    }
</style>
