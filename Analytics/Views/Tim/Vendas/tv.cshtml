@{
    Layout = "~/Views/master.cshtml";
}

<div ng-controller="ctrl-tim-tv">
    <div ng-if="dashboard.status == 200">
        <div class="margin-bottom"></div>

        <div class="row">

            <!--RESUMO-->
            <div class="col-xs-12 col-md-4 margin-bottom">
                <div class="card">
                    <div class="card-body">
                        <div class="margin-bottom"></div>
                        <div class="row">

                            <div class="col-xs-6">
                                <div class="info-box-new bg-new-blue hover-zoom-effect">
                                    <div class="icon">
                                        <i class="material-icons">thumb_up</i>
                                    </div>
                                    <div class="content" style="text-align: center;">
                                        <div class="text">Vendas</div>
                                        <div class="number">{{dashboard.resumo.venda}}</div>
                                    </div>
                                </div>
                            </div>

                            <div class="col-xs-6">
                                <div class="info-box-new bg-new-cyan hover-expand-effect">
                                    <div class="icon">
                                        <i class="material-icons">update</i>
                                    </div>

                                    <div class="content" style="text-align: center;">
                                        <div class="text">Últimos 20min</div>
                                        <div class="number">
                                            + {{dashboard.resumo.venda20}}
                                            <i class="fa fa-caret-up" style="color: #00a65a"></i>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <div class="col-xs-12">
                                <div class="scroller">
                                    <span>
                                        <b style="color: #0073b7">Destaques da última hora</b>  &nbsp &nbsp &nbsp
                                        <n ng-repeat="o in dashboard.operador">
                                            {{o.atendente}} <b style="color: #00a65a">+{{o.venda}} Vendas!</b> &nbsp &nbsp &nbsp
                                        </n>
                                    </span>
                                </div>
                            </div>

                        </div>

                    </div>
                </div>
            </div>

            <!--PLANO-->
            <div class="col-xs-6 col-md-2 margin-bottom">
                <div class="card">
                    <div class="card-body">
                        <high-charts config="dashboard.plano" style="width: 100%; height: 200px"></high-charts>
                    </div>
                </div>
            </div>

            <!--PORTABILIDADE-->
            <div class="col-xs-6 col-md-2 margin-bottom">
                <div class="card">
                    <div class="card-body">
                        <high-charts config="dashboard.portabilidade" style="width: 100%; height: 200px"></high-charts>
                    </div>
                </div>
            </div>

            <!--DEBITO AUTOMATICO-->
            <div class="col-xs-6 col-md-2 margin-bottom">
                <div class="card">
                    <div class="card-body">
                        <high-charts config="dashboard.debito" style="width: 100%; height: 200px"></high-charts>
                    </div>
                </div>
            </div>

            <!--CONTA ONLINE-->
            <div class="col-xs-6 col-md-2 margin-bottom">
                <div class="card">
                    <div class="card-body">
                        <high-charts config="dashboard.contaonline" style="width: 100%; height: 200px"></high-charts>
                    </div>
                </div>
            </div>

            <div class="col-xs-12 col-md-8">

                <!--HORA HORA-->
                <div class="col-xs-12 col-md-6 margin-bottom">
                    <div class="card">
                        <div class="card-body">
                            <high-charts config="dashboard.hora" style="width: 100%; height: 247px"></high-charts>
                        </div>
                    </div>
                </div>

                <!--PROJECAO-->
                <div class="col-xs-12 col-md-6 margin-bottom">
                    <div class="card">
                        <div class="card-body">
                            <high-charts config="dashboard.projecao" style="width: 100%; height: 247px"></high-charts>
                        </div>
                    </div>
                </div>

                <!--DIA DIA-->
                <div class="col-xs-12 col-md-6 margin-bottom">
                    <div class="card">
                        <div class="card-body">
                            <high-charts config="dashboard.dia" style="width: 100%; height: 247px"></high-charts>
                        </div>
                    </div>
                </div>

                <!--SUPERVISOR-->
                <div class="col-xs-12 col-md-6 margin-bottom">
                    <div class="card">
                        <div class="card-body">

                            <div class="table-responsive">
                                <table class="table table-striped table-bordered" style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>TOP 5 Supervisor</th>
                                            <th>Venda</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="s in dashboard.supervisor">
                                            <td>{{s.supervisor}}</td>
                                            <td>{{s.venda}}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!--UF-->
            <div class="col-xs-12 col-md-4 margin-bottom">
                <div class="card">
                    <div class="card-body">
                        <mapa-brasil ballon-Text="both" style="height: 550px" width="100%" dados="dashboard.mapa"></mapa-brasil>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<style>
    .scroller {
        position: relative;
        background-color: black;
        height: 69px;
        line-height: 69px;
        width: 100%;
        padding: 0 10px 0 10px;
        overflow: hidden;
        font-size: 18px;
    }

        .scroller span {
            margin: 0;
            position: absolute;
            color: white;
            overflow: hidden;
            text-overflow: clip;
            white-space: nowrap;
            -moz-transform: translateX(100%);
            -webkit-transform: translateX(100%);
            transform: translateX(100%);
            -moz-animation: scroll-left 30s linear infinite;
            -webkit-animation: scroll-left 30s linear infinite;
            animation: scroll-left 30s linear infinite;
        }

    @@-moz-keyframes scroll-left {
        0% {
            -moz-transform: translateX(100%);
        }

        100% {
            -moz-transform: translateX(-100%);
        }
    }

    @@-webkit-keyframes scroll-left {
        0% {
            -webkit-transform: translateX(100%);
        }

        100% {
            -webkit-transform: translateX(-100%);
        }
    }

    @@keyframes scroll-left {
        0% {
            -moz-transform: translateX(100%); /* Browser bug fix */
            -webkit-transform: translateX(100%); /* Browser bug fix */
            transform: translateX(100%);
        }

        100% {
            -moz-transform: translateX(-100%); /* Browser bug fix */
            -webkit-transform: translateX(-100%); /* Browser bug fix */
            transform: translateX(-100%);
        }
    }
</style>

<script>
    angular.module('app').controller('ctrl-tim-tv', function ($scope, $http, $filter) {
        document.body.classList.remove('menu-opened');

        // carregar o dashboard a cada 20min (no minuto 02, 22, 42)
        setInterval(function () {
            let min = new Date().getMinutes();
            if (min % 20 == 2)
                $scope.carregarDashboard();
        }, 60000);

        $scope.dashboard = {};

        $scope.carregarDashboard = function () {
            $http({
                method: 'POST',
                url: "/api/tim/vendas/tv",
                data: $scope.filtros,
            }).then(function success(r) {

                // #1 TOTAL
                $scope.dashboard.resumo = r.data.Table[0];

                // #2 HORA
                $scope.dashboard.hora = {
                    title: {
                        text: 'Vendas de Hoje'
                    },
                    yAxis: {
                        visible: false,
                    },
                    xAxis: {
                        categories: r.data.Table1.map(obj => obj.hora_nome)
                    },
                    series: [
                        {
                            type: 'area',
                            name: 'Venda',
                            color: '#00a65a',
                            dataLabels: {
                                enabled: true,
                            },
                            data: r.data.Table1.map(obj => obj.venda)
                        },
                    ],
                    credits: {
                        enabled: false
                    }
                };

                // #3 PLANO
                $scope.dashboard.plano = {
                    chart: {
                        type: 'column'
                    },
                    title: {
                        text: 'Plano'
                    },
                    yAxis: {
                        visible: false,
                    },
                    xAxis: {
                        categories: r.data.Table2.map(obj => obj.tipo)
                    },
                    legend: {
                        enabled: false,
                    },
                    plotOptions: {
                        column: {
                            dataLabels: {
                                enabled: true,
                            }
                        }
                    },
                    credits: {
                        enabled: false
                    },
                    series: [{ data: r.data.Table2.map(obj => ({ name: obj.tipo, y: obj.venda })) }]
                };

                // #4 UF
                $scope.dashboard.mapa = r.data.Table3.map(obj => ({ id: 'BR-' + obj.uf, value: obj.venda }));

                // #5 SUPERVISOR
                $scope.dashboard.supervisor = r.data.Table4;

                // #6 PORTABILIDADE
                $scope.dashboard.portabilidade = {
                    chart: {
                        type: 'pie'
                    },
                    title: {
                        text: 'Portabilidade',
                    },
                    subtitle: {
                        text: r.data.Table5[0].perc + '%',
                        y: 24,
                        verticalAlign: 'middle',
                        floating: true,
                        style: { 'font-size': '18px' },
                    },
                    tooltip: {
                        pointFormat: '{point.y} <b>{point.percentage:.1f}%</b>'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            innerSize: '70%',
                            dataLabels: {
                                enabled: false,
                                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                            }
                        }
                    },
                    credits: {
                        enabled: false
                    },
                    series: [{ data: r.data.Table5.map(obj => ({ name: obj.portabilidade, y: obj.venda })) }]
                };

                // #7 DEBITO
                $scope.dashboard.debito = {
                    chart: {
                        type: 'pie'
                    },
                    title: {
                        text: 'DébitoAut'
                    },
                    subtitle: {
                        text: r.data.Table6[0].perc + '%',
                        y: 24,
                        verticalAlign: 'middle',
                        floating: true,
                        style: { 'font-size': '18px' },
                    },
                    tooltip: {
                        pointFormat: '{point.y} <b>{point.percentage:.1f}%</b>'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            innerSize: '70%',
                            dataLabels: {
                                enabled: false,
                                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                            }
                        }
                    },
                    credits: {
                        enabled: false
                    },
                    series: [{ data: r.data.Table6.map(obj => ({ name: obj.debito_em_conta, y: obj.venda })) }]
                };

                // #8 CONTAONLINE
                $scope.dashboard.contaonline = {
                    chart: {
                        type: 'pie'
                    },
                    title: {
                        text: 'ContaOnline'
                    },
                    subtitle: {
                        text: r.data.Table7[0].perc + '%',
                        y: 24,
                        verticalAlign: 'middle',
                        floating: true,
                        style: { 'font-size': '18px' },
                    },
                    tooltip: {
                        pointFormat: '{point.y} <b>{point.percentage:.1f}%</b>'
                    },
                    plotOptions: {
                        pie: {
                            allowPointSelect: true,
                            cursor: 'pointer',
                            innerSize: '70%',
                            dataLabels: {
                                enabled: false,
                                format: '<b>{point.name}</b>: {point.percentage:.1f} %',
                            }
                        }
                    },
                    credits: {
                        enabled: false
                    },
                    series: [{ data: r.data.Table7.map(obj => ({ name: obj.aceitou_conta_online, y: obj.venda })) }]
                };

                // #9 OPERADOR
                $scope.dashboard.operador = r.data.Table8;

                // #10 DIA DIA
                let maxdia = Math.min.apply(null, r.data.Table9.map(obj => obj.venda));
                let mindia = Math.max.apply(null, r.data.Table9.map(obj => obj.venda));
                mostrarLabel = function (venda) {
                    if (venda == maxdia || venda == mindia)
                        return true
                    return false;
                }
                let dadosdia = r.data.Table9.map(obj => obj.venda);//, dataLabels: { enabled: mostrarLabel(obj.venda) } }));
                //dadosdia[dadosdia.length - 1].dataLabels = { enabled: true };
                $scope.dashboard.dia = {
                    title: {
                        text: 'Vendas deste Mês'
                    },
                    yAxis: {
                        visible: false,
                    },
                    xAxis: {
                        categories: r.data.Table9.map(obj => obj.data)
                    },
                    series: [
                        {
                            type: 'column',
                            name: 'Venda',
                            color: '#00a65a',
                            data: dadosdia,
                            dataLabels: {
                                enabled: true,
                            },
                        },
                    ],
                    credits: {
                        enabled: false
                    }
                };

                // #11 PROJECAO
                if (r.data.Table10.length > 0) {
                    let dia_venda = r.data.Table11.map(o => ({ y: o.venda }));
                    let dia_projecao = r.data.Table10.map(o => ({ y: o.venda }));
                    dia_venda[dia_venda.length - 1].dataLabels = { enabled: true };
                    dia_projecao[dia_projecao.length - 1].dataLabels = { enabled: true };
                    $scope.dashboard.projecao = {
                        title: {
                            text: 'Projeção de Hoje'
                        },
                        yAxis: {
                            title: {
                                text: ''
                            },
                        },
                        legend: {
                            enabled: false,
                        },
                        xAxis: {
                            categories: r.data.Table11.map(o => o.hora)
                        },
                        series: [
                            {
                                type: 'line',
                                name: 'Projeção',
                                color: 'black',
                                dashStyle: 'dot',
                                marker: { symbol: 'circle' },
                                data: dia_venda
                            },
                            {
                                type: 'area',
                                name: 'Venda',
                                color: 'black',
                                marker: { symbol: 'circle' },
                                data: dia_projecao
                            },
                        ],
                        credits: {
                            enabled: false
                        }
                    };
                }

                // STATUS DASHBOARD OK
                $scope.dashboard.status = r.status;

            });
        }

        $scope.carregarDashboard();
    });

</script>
