@{
    Layout = "~/Views/master.cshtml";
}

<div ng-controller="ctrl-sms-upload">
    <div class="margin-bottom">
        <!--FILTROS 2-->
        <div class="col-xs-12 margin-bottom" ng-if="dashFiltros.status == 200">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Filtros</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!--SEGMENTACOES-->
                        <div class="col-xs-12 col-sm-4 col-md-2">
                            <div class="form-group">
                                <label class="control-sidebar-subheading">Centro de Custo</label>
                                <select ng-model="filtros.centrocusto" class="form-control">
                                    <option value="" selected="selected"> Selecione</option>
                                    <option ng-repeat="cc in dashFiltros.centrocusto" value="{{cc.id_centrocusto}}">{{cc.centrocusto}}</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-xs-12 col-sm-4 col-md-2">
                            <div class="form-group">
                                <label class="control-sidebar-subheading">Carteira</label>
                                <select ng-model="filtros.carteira" class="form-control">
                                    <option value="" selected="selected"> Selecione</option>
                                    <option ng-repeat="c in dashFiltros.carteira" value="{{c.id_carteira}}">{{c.carteira}}</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-xs-12 col-sm-4 col-md-2">
                            <div class="form-group">
                                <label class="control-sidebar-subheading">Fornecedor</label>
                                <select ng-model="filtros.fornecedor" class="form-control">
                                    <option value="" selected="selected"> Selecione</option>
                                    <option ng-repeat="f in dashFiltros.fornecedor" value="{{f.id_fornecedor}}">{{f.fornecedor}}</option>
                                </select>
                            </div>
                        </div>

                        <div class="col-xs-12 col-sm-4 col-md-2">
                            <div class="form-group">
                                <label class="control-sidebar-subheading">Layout do Arquivo</label>
                                <select ng-model="filtros.layout" ng-change="getLayout( filtros.layout )" class="form-control">
                                    <option value="" selected="selected"> Selecione</option>
                                    <option ng-repeat="l in dashFiltros.layout" value="{{l.id_layout}}">{{l.layout}}</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-xs-12 col-sm-4 col-md-2" ng-show="validarSelecao()">
                            <div class="form-group">
                                <label>Upload Arquivo</label>
                                <input type="file" accept="{{arquivo.extensao[0]}}" uploadfile="arquivo" />
                                <input type="hidden" ng-model="arquivo" />
                            </div>
                        </div>
                    </div>


                    <div class="form-group">
                        <button ng-disabled="!validarSelecao()" type="button" class="btn btn-success" data-toggle="control-sidebar">Importar Arquivo</button>
                    </div>
                </div>

            </div>
        </div>

        <div class="row margin-bottom" ng-show="validarSelecao()">
            <div class="col-xs-12">
                <div class="card">
                    <div class="card-header">
                        <span class="card-header-title">Layout do arquivo selecionado</span>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped table-bordered" style="width:100%" ng-if="arquivo.metadados">
                            <thead>
                                <tr>
                                    <th ng-repeat="(key, val) in arquivo.metadados[0]">{{ key }}</th>
                                </tr>
                            </thead>                            
                        </table>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    angular.module('app').controller('ctrl-sms-upload', function ($scope, $http, $filter) {


        $scope.filtros = {

            centrocusto: '',
            carteira: '',
            fornecedor: '',
            layout: '',
            tabela: ''


        };

        $scope.arquivo = {};
        $scope.dashFiltros = {};
        $scope.arquivo = {};

        //carregar os filtros
        $http({
            method: 'GET',
            url: "/api/sms/lote/filtros",
            data: $scope.filtros,
        }).then(function success(r) {

            $scope.dashFiltros.status = r.status;
            $scope.dashFiltros.centrocusto = r.data.Table;
            $scope.dashFiltros.carteira = r.data.Table1;
            $scope.dashFiltros.fornecedor = r.data.Table2;
            $scope.dashFiltros.layout = r.data.Table3;

        });


        $scope.getPreviewLayout = function () {

            $http({
                method: 'POST',
                url: "/api/sms/lote/getPreviewLayout",
                data: $scope.filtros,
            }).then(function success(r) {

                $scope.arquivo.status = r.status;
                $scope.arquivo.metadados = r.data.Table;
                console.log(r.data);
            });
        }


        $scope.validarSelecao = function () {

            let show = false;

            if (!$scope.filtros.centrocusto == '' && !$scope.filtros.carteira == '' && !$scope.filtros.fornecedor == '' && !$scope.filtros.layout == '') {
                show = true;

            }

            return show;
        }

        $scope.getLayout = function (id) {

            let extensao = alasql = ('select extensao_arquivo from ? where id_layout = ' + id + '', [$scope.dashFiltros.layout][0]);
            let tabela = alasql = ('select tabela from ? where id_layout = ' + id + '', [$scope.dashFiltros.layout][0]);

            $scope.filtros.tabela = tabela.map(obj => obj.tabela)[0];
            $scope.arquivo.extensao = extensao.map(obj => obj.extensao_arquivo);

            $scope.getPreviewLayout();
        }



    });
</script>