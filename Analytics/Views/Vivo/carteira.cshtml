@{
    Layout = "~/Views/master.cshtml";
}


<div ng-controller="ctrl-vivo-carteira">
    <div ng-if="dashboard.status == 200">

        <!-- HEADER-->
        <header class="page-header">
            <div class="page-name">Carteira</div>
            <div class="page-menu-button" ng-style="{'background-color': credor.cor_primaria, 'color': credor.cor_fonte_primaria}" onclick="toggleDisplayNone('filtros-window')">
                <i class="fa fa-filter"></i>
                FILTROS
            </div>
        </header>

        <!-- FILTROS -->
        <div class="row margin-bottom" ng-if="dashFiltros.status == 200">
            <div class="col-xs-12">
                <div id="filtros-window" class="card display-none">
                    <div class="card-header">
                        <span class="card-header-title">Filtros</span>
                        <div class="card-header-button card-header-close">
                            <i class="fa fa-close"></i>
                        </div>
                        <div class="card-header-button card-header-expand">
                            <i class="fa fa-expand"></i>
                        </div>
                    </div>
                    <div class="card-body">

                        <!--DATA INCIAL-->
                        <div class="form-group">
                            <label class="control-sidebar-subheading">Data Inicial</label>
                            <div class="input-group date">
                                <div class="input-group-addon">
                                    <i class="fa fa-calendar"></i>
                                </div>
                                <date-picker class="form-control pull-right" placeholder="yyyy-mm-dd" ng-model="filtros.dtini"></date-picker>
                            </div>
                        </div>

                        <!--DATA FINAL-->
                        <div class="form-group">
                            <label class="control-sidebar-subheading">Data Final</label>
                            <div class="input-group date">
                                <div class="input-group-addon">
                                    <i class="fa fa-calendar"></i>
                                </div>
                                <date-picker class="form-control pull-right" placeholder="yyyy-mm-dd" ng-model="filtros.dtfim"></date-picker>
                            </div>
                        </div>

                        <!--EMPRESA-->
                        <div class="form-group">
                            <label class="control-sidebar-subheading">Empresa</label>
                            <select2 style="width: 100%" class="form-control" data-placeholder="Selecione" ng-model="filtros.empresa" dados="dashFiltros.empresa"></select2>
                        </div>

                        <!--CARTEIRA-->
                        <div class="form-group">
                            <label class="control-sidebar-subheading">Billing</label>
                            <select2 style="width: 100%" class="form-control" data-placeholder="Selecione" ng-model="filtros.tipobilling" dados="dashFiltros.tipobilling"></select2>
                        </div>

                        <!--AGING-->
                        <div class="form-group">
                            <label class="control-sidebar-subheading">Aging</label>
                            <select2 style="width: 100%" class="form-control" data-placeholder="Selecione" ng-model="filtros.aging" dados="dashFiltros.aging"></select2>
                        </div>

                        <!--SEGMENTACAO-->
                        <div class="form-group">
                            <label class="control-sidebar-subheading">Segmentação Vivo</label>
                            <select2 style="width: 100%" class="form-control" data-placeholder="Selecione" ng-model="filtros.segmentacao" dados="dashFiltros.segmentacao"></select2>
                        </div>

                        <!--CAMPANHA NECTAR-->
                        <div class="form-group">
                            <label class="control-sidebar-subheading">Campanha Nectar</label>
                            <select2 style="width: 100%" class="form-control" data-placeholder="Selecione" ng-model="filtros.campanhaNectar" dados="dashFiltros.campanhaNectar"></select2>
                        </div>

                        <!--SEGMENTACAO NECTAR-->
                        <div class="form-group">
                            <label class="control-sidebar-subheading">Segmentação Nectar</label>
                            <select2 style="width: 100%" class="form-control" data-placeholder="Selecione" ng-model="filtros.segmentacaoNectar" dados="dashFiltros.segmentacaoNectar"></select2>
                        </div>

                        <!--BOTÃO-->
                        <div class="form-group">
                            <button type="button" class="btn btn-primary" data-toggle="control-sidebar" ng-click="carregarDashboard()" onclick="addDisplayNone('filtros-window')">Carregar Dados</button>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!--FILTRO INDICADOR-->
        <div class="row margin-bottom">
            <div class="text-center margin-bottom">
                <label class="control-sidebar-subheading">Indicador:</label>
                <select ng-model="grafico.indicador" ng-change="carregarGraficos()">
                    <option value="carteira_qtd">Quantidade Carteira</option>
                    <option value="inclusao_qtd">Quantidade Inclusões</option>
                    <option value="devolucao_qtd">Quantidade Devoluções</option>
                    <option value="carteira_vlr">Valor Carteira</option>
                    <option value="inclusao_vlr">Valor Inclusões</option>
                    <option value="devolucao_vlr">Valor Devoluções</option>
                </select>
            </div>
        </div>

        <!--GRAFICO POR DIA-->
        <div class="row margin-bottom">
            <div class="col-xs-12 margin-bottom">
                <div class="card">
                    <div class="card-header">
                        <span class="card-header-title">Gráfico por Dia</span>
                        <div class="card-header-button card-header-expand">
                            <i class="fa fa-expand"></i>
                        </div>
                        <div class="card-header-button" ng-click="extrair('VolumeDia','Table2')">
                            <i class="fa fa-file-excel-o"></i>
                        </div>
                    </div>
                    <div class="card-body">
                        <high-chart series="dashboard.dia" axis-Categories="dashboard.dias" plot-Options-Line-Data-Label="true" type="column" height="300"></high-chart>
                    </div>
                </div>
            </div>
        </div>

        <!--EMPRESA-->
        <div class="col-xs-12 col-md-6 margin-bottom">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Empresa</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table1')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>
                <div class="card-body">
                    <high-chart series="dashboard.empresa" type="pie" height="300" tooltip-Point-Format="{point.y} (<b>{point.percentage:.1f}%</b>)"></high-chart>
                </div>
            </div>
        </div>

        <!--AGING-->
        <div class="col-xs-12 col-md-6 margin-bottom">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Aging</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table2')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>
                <div class="card-body">
                    <high-chart series="dashboard.aging" axis-Categories="dashboard.agings" plot-Options-Column-Data-Label="true" height="300"></high-chart>
                </div>
            </div>
        </div>

        <!--SEGMENTACAO-->
        <div class="col-xs-12 col-md-6 margin-bottom">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Segmentação</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table3')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>
                <div class="card-body">
                    <high-chart series="dashboard.segmentacao" axis-Categories="dashboard.segmentacoes" plot-Options-Column-Data-Label="true" height="300"></high-chart>
                </div>
            </div>
        </div>

        <!--BILLING-->
        <div class="col-xs-12 col-md-6 margin-bottom">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Billing</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table4')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>
                <div class="card-body">
                    <high-chart series="dashboard.billing" axis-Categories="dashboard.billings" plot-Options-Bar-Data-Label="true" height="300"></high-chart>
                </div>
            </div>
        </div>

        <!--FAIXA DE ATRASO-->
        <div class="col-xs-12 col-md-12 margin-bottom">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Faixa de Atraso</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table5')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>
                <div class="card-body">
                    <high-chart series="dashboard.faixaatraso" axis-Categories="dashboard.faixasatrasos" plot-Options-Column-Data-Label="true" height="300"></high-chart>
                </div>
            </div>
        </div>

        <!--GRÁFICO ESTADO-->
        <div class="col-xs-12 col-md-4 margin-bottom">
            <div class="card">
                <div id="info" class="card-header">
                    <span class="card-header-title">Estado</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table6')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>

                <div class="card-body">
                    <high-chart series="dashboard.estadograf" axis-Categories="dashboard.estados" plot-Options-Bar-Data-Label="true" height="400"></high-chart>
                </div>
            </div>
        </div>

        <!--TABELA ESTADO-->
        <div class="col-xs-12 col-md-8 margin-bottom">
            <div class="card">
                <div id="info" class="card-header">
                    <span class="card-header-title">Região</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table6')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>

                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered" style="width:100%" ng-if="dashboard.estado">
                            <thead>
                                <tr>
                                    <th>Região</th>
                                    <th>Carteira Ativa</th>
                                    <th>Inclusões</th>
                                    <th>Devoluções</th>
                                    <th>R$ Carteira</th>
                                    <th>R$ Inclusão</th>
                                    <th>R$ Devolução</th>
                                </tr>
                            </thead>
                            <tbody ng-repeat="e in dashboard.estado | groupBy: 'ds_regiao'">
                                <tr class="text-bold">
                                    <td>
                                        <i class="fa fa margin-right-5" ng-click="showTbody = !showTbody" ng-class="showTbody ? 'fa-minus' : 'fa-plus'"></i>
                                        {{e[0].ds_regiao}}
                                    </td>
                                    <td>{{e | sumByColumn: 'carteira_qtd'| number}}</td>
                                    <td>{{e | sumByColumn: 'inclusao_qtd'| number}}</td>
                                    <td>{{e | sumByColumn: 'devolucao_qtd'| number}}</td>
                                    <td>{{e | sumByColumn: 'carteira_vlr'| currency:'R$ '}}</td>
                                    <td>{{e | sumByColumn: 'inclusao_vlr'| currency:'R$ '}}</td>
                                    <td>{{e | sumByColumn: 'devolucao_vlr'| currency:'R$ '}}</td>
                                </tr>
                                <tr ng-repeat="p in e" ng-show="showTbody">
                                    <td>{{p.ds_estado}}</td>
                                    <td>{{p.carteira_qtd | number}}</td>
                                    <td>{{p.inclusao_qtd | number}}</td>
                                    <td>{{p.devolucao_qtd | number}}</td>
                                    <td>{{p.carteira_vlr | currency:'R$ '}}</td>
                                    <td>{{p.inclusao_vlr | currency:'R$ '}}</td>
                                    <td>{{p.devolucao_vlr | currency:'R$ '}}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!--FAIXA DE VALOR-->
        <div class="col-xs-12 col-md-12 margin-bottom">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Faixa de Valor $</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table5')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>
                <div class="card-body">
                    <high-chart series="dashboard.faixavalor" axis-Categories="dashboard.faixasvalores" plot-Options-Column-Data-Label="true" height="300"></high-chart>
                </div>
            </div>
        </div>

        <!--SITUAÇÃO DO CONTRATO-->
        <div class="col-xs-12 col-md-6 margin-bottom">
            <div class="card">
                <div id="info" class="card-header">
                    <span class="card-header-title">Situação</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table7')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>

                <div class="card-body">
                    <high-chart series="dashboard.situacao" axis-Categories="dashboard.situacoes" plot-Options-Bar-Data-Label="true" height="600"></high-chart>
                </div>
            </div>
        </div>

        <!--CAMPANHA DO NECTAR-->
        <div class="col-xs-12 col-md-6 margin-bottom">
            <div class="card">
                <div id="info" class="card-header">
                    <span class="card-header-title">Campanha do Nectar</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table9')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>

                <div class="card-body">
                    <high-chart series="dashboard.campanhanectar" axis-Categories="dashboard.campanhasnectar" plot-Options-Bar-Data-Label="true" height="600"></high-chart>
                </div>
            </div>
        </div>


        <!--SEGMENTAÇÃO NECTAR-->
        <div class="col-xs-8 col-md-12 margin-bottom">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Segmentações do Nectar</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table11')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>
                <div class="card-body">
                    <d-table class="table table-striped table-bordered" style="width:100%" dados="dashboard.segmentacaonectar" scroll-collapse="true" scroll-y="324px"></d-table>
                </div>
            </div>
        </div>

        <!--STATUS SEGMENTACAO NECTAR-->
        <div class="col-xs-12 col-md-12 margin-bottom">
            <div class="card">
                <div class="card-header">
                    <span class="card-header-title">Status de Segmentações Nectar</span>
                    <div class="card-header-button card-header-expand">
                        <i class="fa fa-expand"></i>
                    </div>
                    <div class="card-header-button" ng-click="extrair('Table10')">
                        <i class="fa fa-file-excel-o"></i>
                    </div>
                </div>
                <div class="card-body">
                    <high-chart series="dashboard.statussegmentacaonectar" type="pie" height="300" tooltip-Point-Format="{point.y} (<b>{point.percentage:.1f}%</b>)"></high-chart>
                </div>
            </div>
        </div>


    </div>
</div>


<script>

    angular.module('app').controller('ctrl-vivo-carteira', function ($scope, $http, $filter) {

        // filtros iniciais
        let newdate = new Date();
        let primeiroDiaMes = new Date(newdate.getFullYear(), newdate.getMonth(), 1);

        $scope.filtros = {
            dtini: $filter('date')(primeiroDiaMes, "yyyy-MM-dd"),
            dtfim: $filter('date')(newdate, "yyyy-MM-dd"),
            empresa: '',
            tipobilling: '',
            aging: '',
            segmentacao: '',
            campanhaNectar: '',
            segmentacaoNectar: '',
        };

        $scope.dashFiltros = {};
        $scope.dashboard = {};

        $scope.grafico = { indicador: 'carteira_qtd' };

        // carregar os filtros
        $http({
            method: 'GET',
            url: "/api/vivo/new/humano/dashboard/filtros",
            data: $scope.filtros,
        }).then(function success(r) {

            $scope.dashFiltros.status = r.status;

            $scope.dashFiltros.empresa = r.data.Table;
            $scope.dashFiltros.tipobilling = r.data.Table1;
            $scope.dashFiltros.aging = r.data.Table2;
            $scope.dashFiltros.segmentacao = r.data.Table6;
            $scope.dashFiltros.campanhaNectar = r.data.Table7;
            $scope.dashFiltros.segmentacaoNectar = r.data.Table8;

        });


        $scope.carregarDashboard = function () {
            $http({
                method: 'POST',
                url: "/api/vivo/dashboard/carteira",
                data: $scope.filtros,
            }).then(function success(r) {

                $scope.dashboard.status = r.status;
                $scope.dashboard.dados = r.data;

                $scope.dashboard.estado = r.data.Table6;
                $scope.dashboard.segmentacaonectar = r.data.Table11;
                $scope.carregarGraficos();

                //cubo.carregar(r.data.Table);
                //$scope.popularDashboard();
                //$scope.popularFiltros();
            });
        }

        $scope.carregarGraficos = function () {
            let dados = $scope.dashboard.dados;
            let indicador = $scope.grafico.indicador;

            $scope.dashboard.dias = dados.Table.map(obj => obj.data);
            $scope.dashboard.dia = [{ name: indicador, type: "line", color: 'black', data: dados.Table.map(obj => (obj[indicador])) }];

            $scope.dashboard.empresa = [{ name: indicador, innerSize: '30%', data: dados.Table1.map(obj => ({ name: obj.ds_empresa, y: obj[indicador] })) }];

            $scope.dashboard.agings = dados.Table2.map(obj => obj.ds_aging);
            $scope.dashboard.aging = [{ name: indicador, type: 'column', color: 'rgb(126, 37, 149)', data: dados.Table2.map(obj => obj[indicador]) }];

            $scope.dashboard.segmentacoes = dados.Table3.map(obj => obj.ds_segmentacao);
            $scope.dashboard.segmentacao = [{ name: indicador, type: 'column', data: dados.Table3.map(obj => obj[indicador]) }];

            $scope.dashboard.billings = dados.Table4.map(obj => obj.ds_tipo_billing);
            $scope.dashboard.billing = [{ name: indicador, type: 'bar', color: 'black', data: dados.Table4.map(obj => obj[indicador]) }];

            $scope.dashboard.faixasatrasos = dados.Table5.map(obj => obj.ds_faixa_atraso);
            $scope.dashboard.faixaatraso = [{ name: indicador, type: 'column', data: dados.Table5.map(obj => obj[indicador]) }];

            $scope.dashboard.estados = dados.Table6.map(obj => obj.ds_estado);
            $scope.dashboard.estadograf = [{ name: indicador, type: 'bar', data: dados.Table6.map(obj => obj[indicador]) }];

            $scope.dashboard.faixasvalores = dados.Table7.map(obj => obj.ds_faixa_valor);
            $scope.dashboard.faixavalor = [{ name: indicador, type: 'column', color:'#056338' ,  data: dados.Table7.map(obj => obj[indicador]) }];

            $scope.dashboard.situacoes = dados.Table8.map(obj => obj.ds_situacao);
            $scope.dashboard.situacao = [{ name: indicador, type: 'bar', data: dados.Table8.map(obj => obj[indicador]) }];

            $scope.dashboard.campanhasnectar = dados.Table9.map(obj => obj.ds_campanha);
            $scope.dashboard.campanhanectar = [{ name: indicador, type: 'bar', data: dados.Table9.map(obj => obj[indicador]) }];

            $scope.dashboard.statussegmentacaonectar = [{ name: indicador, innerSize: '30%', data: dados.Table10.map(obj => ({ name: obj.ds_status, y: obj[indicador] })) }];

        }

        $scope.carregarDashboard();

        // extrair dados para excel
        $scope.extrair = function (tabela) {
            alasql('SELECT * INTO XLSX("analytics.xlsx", {headers: true}) FROM ?', [$scope.dashboard.dados[tabela]]);
        }

    });

</script>
