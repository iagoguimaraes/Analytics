@{
    Layout = "~/Views/master.cshtml";
}


<div ng-controller="ctrl-vivo-score">
    <div ng-if="dashboard.status === 200">

        <!-- HEADER-->
        <header class="page-header">
            <div class="page-name">Score Collection</div>
        </header>

        <!--FILTRO DE LOTE-->
        <div class="margin-bottom">
            <label style="font-size: 16px;">
                Lote:
                <select ng-model="dashboard.opt.lote" ng-change="obterMaiorDia()">
                    <option value="1">Piloto: 07/11/2018 (Lote: 2018-10-31)</option>
                    <option value="2">Piloto: 21/11/2018 (Lote: 2018-11-19)</option>
                    <option value="3">Piloto: 29/11/2018 (Lote: 2018-11-26)</option>
                </select>
            </label>
        </div>

        <!--VISÃO GERAL-->
        <div class="row margin-bottom">
            <div class="col-xs-12">
                <div class="card">
                    <div class="card-header">
                        <span class="card-header-title">Visão Geral</span>
                        <div class="card-header-button card-header-expand">
                            <i class="fa fa-expand"></i>
                        </div>
                        <div class="pull-right">
                            <label>Dia de Permanencia:</label>
                            <input ng-model="dashboard.opt.permanencia" ng-change="carregarVisalGeral()" style="line-height: normal" type="number" min="0" max="20" value="0" />
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" ng-if="dashboard.visaogeral">
                            <table id="visaogeral" class="table table-striped table-bordered" style="width:100%">
                                <thead>
                                    <tr>
                                        <th rowspan="1" style="vertical-align: middle;">Agrupamento</th>
                                        <th colspan="1" style="text-align: center; background-color: #F2F2F2;">< 6 Meses</th>
                                        <th colspan="3" style="text-align: center; background-color: #ECECEC;">Acima de 6 Meses</th>
                                        <th rowspan="2" style="text-align: center; background-color: #E8E8E8; vertical-align: middle;">Total <i class="fa fa-th-list"></i></th>
                                        <th colspan="5">
                                            Acionamento
                                            <select ng-model="dashboard.opt.acionamento" ng-change="carregarVisalGeral()" class="pull-right">
                                                <option value="qtd">Qtd Total</option>
                                                <option value="unq">Qtd Unique</option>
                                                <option value="esf">Esforço</option>
                                                <option value="spin">Spin</option>
                                            </select>
                                        </th>
                                    </tr>
                                    <tr>
                                        <th>
                                            <select ng-model="dashboard.opt.visaogeral" ng-change="carregarVisalGeral()">
                                                <option value="baixa">% Baixa</option>
                                                <option value="pgto">% Pagamento</option>
                                                <option value="contas">Contas</option>
                                            </select>
                                        </th>
                                        <th style="text-align: center; background-color: #F2F2F2;">Geral <i class="fa fa-circle" style="color: black;"></i></th>
                                        <th style="text-align: center; background-color: #ECECEC;">Alto <i class="fa fa-circle" style="color: red;"></i></th>
                                        <th style="text-align: center; background-color: #ECECEC;">Médio <i class="fa fa-circle" style="color: orange;"></i></th>
                                        <th style="text-align: center; background-color: #ECECEC;">Baixo <i class="fa fa-circle" style="color: green;"></i></th>
                                        <th style="text-align: center; vertical-align: middle;"><i class="fa fa-envelope-o"></i> EMAIL</th>
                                        <th style="text-align: center; vertical-align: middle;"><i class="fa fa-commenting"></i> SMS</th>
                                        <th style="text-align: center; vertical-align: middle;"><i class="fa fa-phone"></i> URA</th>
                                        <th style="text-align: center; vertical-align: middle;"><i class="fa fa-mobile"></i> SMG</th>
                                        <th style="text-align: center; vertical-align: middle;"><i class="fa fa-headphones"></i> VOZ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                <tbody>
                                    <tr ng-repeat="r in dashboard.visaogeral">
                                        <td>{{r.agrupamento}}</td>
                                        <td style="text-align: center; background-color: #F2F2F2;" ng-style="{'background-color': obterCor(r.id_agrupamento, r.menor6geral, minmax.minmax_menor6geral[0],minmax.minmax_menor6geral[1])}">{{r.menor6geral}}</td>
                                        <td style="text-align: center; background-color: #ECECEC;" ng-style="{'background-color': obterCor(r.id_agrupamento, r.maior6alto, minmax.minmax_maior6alto[0],minmax.minmax_maior6alto[1])}">{{r.maior6alto}}</td>
                                        <td style="text-align: center; background-color: #ECECEC;" ng-style="{'background-color': obterCor(r.id_agrupamento, r.maior6medio, minmax.minmax_maior6medio[0],minmax.minmax_maior6medio[1])}">{{r.maior6medio}}</td>
                                        <td style="text-align: center; background-color: #ECECEC;" ng-style="{'background-color': obterCor(r.id_agrupamento, r.maior6baixo, minmax.minmax_maior6baixo[0],minmax.minmax_maior6baixo[1])}">{{r.maior6baixo}}</td>
                                        <td style="text-align: center; background-color: #E8E8E8;" ng-style="{'background-color': obterCor(r.id_agrupamento, r.total, minmax.minmax_total[0],minmax.minmax_total[1])}">{{r.total}}</td>
                                        <td style="text-align: center; background-color: #E8E8E8;">{{r.email}}</td>
                                        <td style="text-align: center; background-color: #E8E8E8;">{{r.sms}}</td>
                                        <td style="text-align: center; background-color: #E8E8E8;">{{r.ura}}</td>
                                        <td style="text-align: center; background-color: #E8E8E8;">{{r.smg}}</td>
                                        <td style="text-align: center; background-color: #E8E8E8;">{{r.voz}}</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th>Total do Piloto</th>
                                        <th style="text-align: center; background-color: #F2F2F2;">{{dashboard.visaogeral_tt.menor6geral}}</th>
                                        <th style="text-align: center; background-color: #ECECEC;">{{dashboard.visaogeral_tt.maior6alto}}</th>
                                        <th style="text-align: center; background-color: #ECECEC;">{{dashboard.visaogeral_tt.maior6medio}}</th>
                                        <th style="text-align: center; background-color: #ECECEC;">{{dashboard.visaogeral_tt.maior6baixo}}</th>
                                        <th style="text-align: center; background-color: #E8E8E8;">{{dashboard.visaogeral_tt.total}}</th>
                                        <th style="text-align: center; background-color: #E8E8E8;">{{dashboard.visaogeral_tt.email}}</th>
                                        <th style="text-align: center; background-color: #E8E8E8;">{{dashboard.visaogeral_tt.sms}}</th>
                                        <th style="text-align: center; background-color: #E8E8E8;">{{dashboard.visaogeral_tt.ura}}</th>
                                        <th style="text-align: center; background-color: #E8E8E8;">{{dashboard.visaogeral_tt.smg}}</th>
                                        <th style="text-align: center; background-color: #E8E8E8;">{{dashboard.visaogeral_tt.voz}}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!--FILTROS-->
        <div class="row margin-bottom">
            <div class="col-xs-4">
                <label>Agrupamento</label>
                <select ng-model="dashboard.opt.filtro_agrupamento" ng-change="carregarBaixas();" style="width: 100%;">
                    <option value="0">Tudo</option>
                    <option value="1">Espontâneo</option>
                    <option value="2">Super Amigável</option>
                    <option value="3">Amigável</option>
                    <option value="4">Baixa Hostilidade</option>
                    <option value="5">Hostil</option>
                    <option value="6">Super Hostilidade</option>
                </select>
            </div>
            <div class="col-xs-4">
                <label>Tempo de Casa</label>
                <select ng-model="dashboard.opt.filtro_tempocasa" ng-change="carregarBaixas();" style="width: 100%;">
                    <option value="0">Tudo</option>
                    <option value="1">Abaixo de 6 Meses</option>
                    <option value="2">Acima de 6 Meses</option>
                </select>
            </div>
            <div class="col-xs-4">
                <label>Risco</label>
                <select ng-model="dashboard.opt.filtro_risco" ng-change="carregarBaixas();" style="width: 100%;">
                    <option value="0">Tudo</option>
                    <option value="1">Alto</option>
                    <option value="2">Médio</option>
                    <option value="3">Baixo</option>
                </select>
            </div>
        </div>

        <!--BAIXAS-->
        <div class="row margin-bottom">
            <div class="col-xs-12">
                <div class="card">
                    <div class="card-header">
                        <span class="card-header-title">Baixas</span>
                        <div class="card-header-button card-header-expand">
                            <i class="fa fa-expand"></i>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-xs-12 col-md-4">
                                <high-charts config="dashboard.baixa_tempocasa" style="height: 300px; width: 100%;"></high-charts>
                            </div>

                            <div class="col-xs-12 col-md-4">
                                <high-charts config="dashboard.baixa_risco" style="height: 300px; width: 100%;"></high-charts>
                            </div>

                            <div class="col-xs-12 col-md-4">
                                <high-chart series="dashboard.baixa_agrupamento" axis-Categories="dashboard.agrupamento" plot-Options-Bar-Data-Label="true" type="bar" height="300"></high-chart>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    angular.module('app').controller('ctrl-vivo-score', function ($scope, $http, $filter) {

        $scope.dashboard = {};
        $scope.dashboard.opt = {
            lote: '3',
            permanencia: 0,
            visaogeral: 'baixa',
            acionamento: 'qtd',
            filtro_agrupamento: '0',
            filtro_tempocasa: '0',
            filtro_risco: '0',
        };

        $scope.carregarDashboard = function () {
            $http({
                method: 'POST',
                url: "/api/vivo/dashboard/score2",
                data: $scope.filtros,
            }).then(function success(r) {
                $scope.dashboard.status = r.status;
                $scope.dashboard.dados = r.data.Table;

                $scope.obterMaiorDia();
                $scope.carregarVisalGeral();
                $scope.carregarBaixas();
            });
        }

        $scope.obterMaiorDia = function () {
            $scope.dashboard.opt.permanencia = $scope.dashboard.dados.find(o => o.id_piloto == $scope.dashboard.opt.lote && o.atual).dia;
            $scope.carregarVisalGeral();
            $scope.carregarBaixas();
        };

        $scope.carregarVisalGeral = function () {          
            let dados = $scope.dashboard.dados.filter(o => o.id_piloto == $scope.dashboard.opt.lote && o.dia == $scope.dashboard.opt.permanencia);

            $scope.dashboard.visaogeral = alasql(`
                    select
                         id_agrupamento
                        ,agrupamento
                        ,sum(case when id_tempocasa = 1 then contas else 0 end) c_menor6geral
	                    ,sum(case when id_tempocasa = 2 and id_risco = 1 then contas else 0 end) c_maior6alto
	                    ,sum(case when id_tempocasa = 2 and id_risco = 2 then contas else 0 end) c_maior6medio
	                    ,sum(case when id_tempocasa = 2 and id_risco = 3 then contas else 0 end) c_maior6baixo
                        ,sum(case when id_tempocasa = 1 then estoque else 0 end) e_menor6geral
	                    ,sum(case when id_tempocasa = 2 and id_risco = 1 then estoque else 0 end) e_maior6alto
	                    ,sum(case when id_tempocasa = 2 and id_risco = 2 then estoque else 0 end) e_maior6medio
	                    ,sum(case when id_tempocasa = 2 and id_risco = 3 then estoque else 0 end) e_maior6baixo
                        ,sum(case when id_tempocasa = 1 then pagamento else 0 end) p_menor6geral
	                    ,sum(case when id_tempocasa = 2 and id_risco = 1 then pagamento else 0 end) p_maior6alto
	                    ,sum(case when id_tempocasa = 2 and id_risco = 2 then pagamento else 0 end) p_maior6medio
	                    ,sum(case when id_tempocasa = 2 and id_risco = 3 then pagamento else 0 end) p_maior6baixo
                        ,sum(contas) contas
                        ,sum(estoque) estoque
                        ,sum(pagamento) pagamento
                        ,sum(email) email_unq
                        ,sum(sms) sms_unq
                        ,sum(ura) ura_unq
                        ,sum(smg) smg_unq
                        ,sum(voz) voz_unq
                        ,sum(email_tt) email_tt
                        ,sum(sms_tt) sms_tt
                        ,sum(ura_tt) ura_tt
                        ,sum(smg_tt) smg_tt
                        ,sum(voz_tt) voz_tt
                     from
                        ?
                    group by
                         id_agrupamento
                        ,agrupamento
                    `, [dados]);
            $scope.dashboard.visaogeral_tt = alasql(`
                    select
                         sum(c_menor6geral) c_menor6geral
	                    ,sum(c_maior6alto) c_maior6alto
	                    ,sum(c_maior6medio) c_maior6medio
	                    ,sum(c_maior6baixo) c_maior6baixo
                        ,sum(e_menor6geral) e_menor6geral
	                    ,sum(e_maior6alto) e_maior6alto
	                    ,sum(e_maior6medio) e_maior6medio
	                    ,sum(e_maior6baixo) e_maior6baixo
                        ,sum(p_menor6geral) p_menor6geral
	                    ,sum(p_maior6alto) p_maior6alto
	                    ,sum(p_maior6medio) p_maior6medio
	                    ,sum(p_maior6baixo) p_maior6baixo
                        ,sum(contas) contas
                        ,sum(estoque) estoque
                        ,sum(pagamento) pagamento
                        ,sum(email_unq) email_unq
                        ,sum(sms_unq) sms_unq
                        ,sum(ura_unq) ura_unq
                        ,sum(smg_unq) smg_unq
                        ,sum(voz_unq) voz_unq
                        ,sum(email_tt) email_tt
                        ,sum(sms_tt) sms_tt
                        ,sum(ura_tt) ura_tt
                        ,sum(smg_tt) smg_tt
                        ,sum(voz_tt) voz_tt
                     from
                        ?
                    where
                        id_agrupamento > 0
                    `, [$scope.dashboard.visaogeral])[0];

            if ($scope.dashboard.opt.visaogeral == 'contas') {
                for (r in $scope.dashboard.visaogeral) {
                    $scope.dashboard.visaogeral[r].menor6geral = $filter('number')($scope.dashboard.visaogeral[r].c_menor6geral)
                    $scope.dashboard.visaogeral[r].maior6alto = $filter('number')($scope.dashboard.visaogeral[r].c_maior6alto)
                    $scope.dashboard.visaogeral[r].maior6medio = $filter('number')($scope.dashboard.visaogeral[r].c_maior6medio)
                    $scope.dashboard.visaogeral[r].maior6baixo = $filter('number')($scope.dashboard.visaogeral[r].c_maior6baixo)
                    $scope.dashboard.visaogeral[r].total = $filter('number')($scope.dashboard.visaogeral[r].contas)
                }
                $scope.dashboard.visaogeral_tt.menor6geral = $filter('number')($scope.dashboard.visaogeral_tt.c_menor6geral)
                $scope.dashboard.visaogeral_tt.maior6alto = $filter('number')($scope.dashboard.visaogeral_tt.c_maior6alto)
                $scope.dashboard.visaogeral_tt.maior6medio = $filter('number')($scope.dashboard.visaogeral_tt.c_maior6medio)
                $scope.dashboard.visaogeral_tt.maior6baixo = $filter('number')($scope.dashboard.visaogeral_tt.c_maior6baixo)
                $scope.dashboard.visaogeral_tt.total = $filter('number')($scope.dashboard.visaogeral_tt.contas)
            }
            if ($scope.dashboard.opt.visaogeral == 'baixa') {
                for (r in $scope.dashboard.visaogeral) {
                    $scope.dashboard.visaogeral[r].menor6geral = $filter('percentage')(1 - ($scope.dashboard.visaogeral[r].e_menor6geral / $scope.dashboard.visaogeral[r].c_menor6geral), 1)
                    $scope.dashboard.visaogeral[r].maior6alto = $filter('percentage')(1 - ($scope.dashboard.visaogeral[r].e_maior6alto / $scope.dashboard.visaogeral[r].c_maior6alto), 1)
                    $scope.dashboard.visaogeral[r].maior6medio = $filter('percentage')(1 - ($scope.dashboard.visaogeral[r].e_maior6medio / $scope.dashboard.visaogeral[r].c_maior6medio), 1)
                    $scope.dashboard.visaogeral[r].maior6baixo = $filter('percentage')(1 - ($scope.dashboard.visaogeral[r].e_maior6baixo / $scope.dashboard.visaogeral[r].c_maior6baixo), 1)
                    $scope.dashboard.visaogeral[r].total = $filter('percentage')(1 - ($scope.dashboard.visaogeral[r].estoque / $scope.dashboard.visaogeral[r].contas), 1)
                }
                $scope.dashboard.visaogeral_tt.menor6geral = $filter('percentage')(1 - ($scope.dashboard.visaogeral_tt.e_menor6geral / $scope.dashboard.visaogeral_tt.c_menor6geral), 1)
                $scope.dashboard.visaogeral_tt.maior6alto = $filter('percentage')(1 - ($scope.dashboard.visaogeral_tt.e_maior6alto / $scope.dashboard.visaogeral_tt.c_maior6alto), 1)
                $scope.dashboard.visaogeral_tt.maior6medio = $filter('percentage')(1 - ($scope.dashboard.visaogeral_tt.e_maior6medio / $scope.dashboard.visaogeral_tt.c_maior6medio), 1)
                $scope.dashboard.visaogeral_tt.maior6baixo = $filter('percentage')(1 - ($scope.dashboard.visaogeral_tt.e_maior6baixo / $scope.dashboard.visaogeral_tt.c_maior6baixo), 1)
                $scope.dashboard.visaogeral_tt.total = $filter('percentage')(1 - ($scope.dashboard.visaogeral_tt.estoque / $scope.dashboard.visaogeral_tt.contas), 1)
            }
            if ($scope.dashboard.opt.visaogeral == 'pgto') {
                for (r in $scope.dashboard.visaogeral) {
                    $scope.dashboard.visaogeral[r].menor6geral = $filter('percentage')(($scope.dashboard.visaogeral[r].p_menor6geral / $scope.dashboard.visaogeral[r].c_menor6geral), 1)
                    $scope.dashboard.visaogeral[r].maior6alto = $filter('percentage')(($scope.dashboard.visaogeral[r].p_maior6alto / $scope.dashboard.visaogeral[r].c_maior6alto), 1)
                    $scope.dashboard.visaogeral[r].maior6medio = $filter('percentage')(($scope.dashboard.visaogeral[r].p_maior6medio / $scope.dashboard.visaogeral[r].c_maior6medio), 1)
                    $scope.dashboard.visaogeral[r].maior6baixo = $filter('percentage')(($scope.dashboard.visaogeral[r].p_maior6baixo / $scope.dashboard.visaogeral[r].c_maior6baixo), 1)
                    $scope.dashboard.visaogeral[r].total = $filter('percentage')(($scope.dashboard.visaogeral[r].pagamento / $scope.dashboard.visaogeral[r].contas), 1)
                }
                $scope.dashboard.visaogeral_tt.menor6geral = $filter('percentage')(($scope.dashboard.visaogeral_tt.p_menor6geral / $scope.dashboard.visaogeral_tt.c_menor6geral), 1)
                $scope.dashboard.visaogeral_tt.maior6alto = $filter('percentage')(($scope.dashboard.visaogeral_tt.p_maior6alto / $scope.dashboard.visaogeral_tt.c_maior6alto), 1)
                $scope.dashboard.visaogeral_tt.maior6medio = $filter('percentage')(($scope.dashboard.visaogeral_tt.p_maior6medio / $scope.dashboard.visaogeral_tt.c_maior6medio), 1)
                $scope.dashboard.visaogeral_tt.maior6baixo = $filter('percentage')(($scope.dashboard.visaogeral_tt.p_maior6baixo / $scope.dashboard.visaogeral_tt.c_maior6baixo), 1)
                $scope.dashboard.visaogeral_tt.total = $filter('percentage')(($scope.dashboard.visaogeral_tt.pagamento / $scope.dashboard.visaogeral_tt.contas), 1)
            }

            if ($scope.dashboard.opt.acionamento == 'qtd') {
                for (r in $scope.dashboard.visaogeral) {
                    $scope.dashboard.visaogeral[r].email = $filter('number')($scope.dashboard.visaogeral[r].email_tt)
                    $scope.dashboard.visaogeral[r].sms = $filter('number')($scope.dashboard.visaogeral[r].sms_tt)
                    $scope.dashboard.visaogeral[r].ura = $filter('number')($scope.dashboard.visaogeral[r].ura_tt)
                    $scope.dashboard.visaogeral[r].smg = $filter('number')($scope.dashboard.visaogeral[r].smg_tt)
                    $scope.dashboard.visaogeral[r].voz = $filter('number')($scope.dashboard.visaogeral[r].voz_tt)
                }
                $scope.dashboard.visaogeral_tt.email = $filter('number')($scope.dashboard.visaogeral_tt.email_tt)
                $scope.dashboard.visaogeral_tt.sms = $filter('number')($scope.dashboard.visaogeral_tt.sms_tt)
                $scope.dashboard.visaogeral_tt.ura = $filter('number')($scope.dashboard.visaogeral_tt.ura_tt)
                $scope.dashboard.visaogeral_tt.smg = $filter('number')($scope.dashboard.visaogeral_tt.smg_tt)
                $scope.dashboard.visaogeral_tt.voz = $filter('number')($scope.dashboard.visaogeral_tt.voz_tt)
            }
            if ($scope.dashboard.opt.acionamento == 'unq') {
                for (r in $scope.dashboard.visaogeral) {
                    $scope.dashboard.visaogeral[r].email = $filter('number')($scope.dashboard.visaogeral[r].email_unq)
                    $scope.dashboard.visaogeral[r].sms = $filter('number')($scope.dashboard.visaogeral[r].sms_unq)
                    $scope.dashboard.visaogeral[r].ura = $filter('number')($scope.dashboard.visaogeral[r].ura_unq)
                    $scope.dashboard.visaogeral[r].smg = $filter('number')($scope.dashboard.visaogeral[r].smg_unq)
                    $scope.dashboard.visaogeral[r].voz = $filter('number')($scope.dashboard.visaogeral[r].voz_unq)
                }
                $scope.dashboard.visaogeral_tt.email = $filter('number')($scope.dashboard.visaogeral_tt.email_unq)
                $scope.dashboard.visaogeral_tt.sms = $filter('number')($scope.dashboard.visaogeral_tt.sms_unq)
                $scope.dashboard.visaogeral_tt.ura = $filter('number')($scope.dashboard.visaogeral_tt.ura_unq)
                $scope.dashboard.visaogeral_tt.smg = $filter('number')($scope.dashboard.visaogeral_tt.smg_unq)
                $scope.dashboard.visaogeral_tt.voz = $filter('number')($scope.dashboard.visaogeral_tt.voz_unq)
            }
            if ($scope.dashboard.opt.acionamento == 'esf') {
                for (r in $scope.dashboard.visaogeral) {
                    $scope.dashboard.visaogeral[r].email = $filter('number')($scope.dashboard.visaogeral[r].email_tt / $scope.dashboard.visaogeral[r].contas, 1)
                    $scope.dashboard.visaogeral[r].sms = $filter('number')($scope.dashboard.visaogeral[r].sms_tt / $scope.dashboard.visaogeral[r].contas, 1)
                    $scope.dashboard.visaogeral[r].ura = $filter('number')($scope.dashboard.visaogeral[r].ura_tt / $scope.dashboard.visaogeral[r].contas, 1)
                    $scope.dashboard.visaogeral[r].smg = $filter('number')($scope.dashboard.visaogeral[r].smg_tt / $scope.dashboard.visaogeral[r].contas, 1)
                    $scope.dashboard.visaogeral[r].voz = $filter('number')($scope.dashboard.visaogeral[r].voz_tt / $scope.dashboard.visaogeral[r].contas, 1)
                }
                $scope.dashboard.visaogeral_tt.email = $filter('number')($scope.dashboard.visaogeral_tt.email_tt / $scope.dashboard.visaogeral_tt.contas, 1)
                $scope.dashboard.visaogeral_tt.sms = $filter('number')($scope.dashboard.visaogeral_tt.sms_tt / $scope.dashboard.visaogeral_tt.contas, 1)
                $scope.dashboard.visaogeral_tt.ura = $filter('number')($scope.dashboard.visaogeral_tt.ura_tt / $scope.dashboard.visaogeral_tt.contas, 1)
                $scope.dashboard.visaogeral_tt.smg = $filter('number')($scope.dashboard.visaogeral_tt.smg_tt / $scope.dashboard.visaogeral_tt.contas, 1)
                $scope.dashboard.visaogeral_tt.voz = $filter('number')($scope.dashboard.visaogeral_tt.voz_tt / $scope.dashboard.visaogeral_tt.contas, 1)
            }
            if ($scope.dashboard.opt.acionamento == 'spin') {
                for (r in $scope.dashboard.visaogeral) {
                    $scope.dashboard.visaogeral[r].email = $filter('number')($scope.dashboard.visaogeral[r].email_tt / $scope.dashboard.visaogeral[r].email_unq, 1)
                    $scope.dashboard.visaogeral[r].sms = $filter('number')($scope.dashboard.visaogeral[r].sms_tt / $scope.dashboard.visaogeral[r].sms_unq, 1)
                    $scope.dashboard.visaogeral[r].ura = $filter('number')($scope.dashboard.visaogeral[r].ura_tt / $scope.dashboard.visaogeral[r].ura_unq, 1)
                    $scope.dashboard.visaogeral[r].smg = $filter('number')($scope.dashboard.visaogeral[r].smg_tt / $scope.dashboard.visaogeral[r].smg_unq, 1)
                    $scope.dashboard.visaogeral[r].voz = $filter('number')($scope.dashboard.visaogeral[r].voz_tt / $scope.dashboard.visaogeral[r].voz_unq, 1)
                }
                $scope.dashboard.visaogeral_tt.email = $filter('number')($scope.dashboard.visaogeral_tt.email_tt / $scope.dashboard.visaogeral_tt.email_unq, 1)
                $scope.dashboard.visaogeral_tt.sms = $filter('number')($scope.dashboard.visaogeral_tt.sms_tt / $scope.dashboard.visaogeral_tt.sms_unq, 1)
                $scope.dashboard.visaogeral_tt.ura = $filter('number')($scope.dashboard.visaogeral_tt.ura_tt / $scope.dashboard.visaogeral_tt.ura_unq, 1)
                $scope.dashboard.visaogeral_tt.smg = $filter('number')($scope.dashboard.visaogeral_tt.smg_tt / $scope.dashboard.visaogeral_tt.smg_unq, 1)
                $scope.dashboard.visaogeral_tt.voz = $filter('number')($scope.dashboard.visaogeral_tt.voz_tt / $scope.dashboard.visaogeral_tt.voz_unq, 1)
            }

            let minmax = {
                menor6geral: [],
                maior6alto: [],
                maior6medio: [],
                maior6baixo: [],
                total: [],
            };

            for (var r = 1; r < 7; r++) {
                minmax.menor6geral.push($scope.dashboard.visaogeral[r].menor6geral.replace('%', '').replace('.', '').replace(',', '.'));
                minmax.maior6alto.push($scope.dashboard.visaogeral[r].maior6alto.replace('%', '').replace('.', '').replace(',', '.'));
                minmax.maior6medio.push($scope.dashboard.visaogeral[r].maior6medio.replace('%', '').replace('.', '').replace(',', '.'));
                minmax.maior6baixo.push($scope.dashboard.visaogeral[r].maior6baixo.replace('%', '').replace('.', '').replace(',', '.'));
                minmax.total.push($scope.dashboard.visaogeral[r].total.replace('%', '').replace('.', '').replace(',', '.'));
            }
            minmax.minmax_menor6geral = [Math.min.apply(null, minmax.menor6geral), Math.max.apply(null, minmax.menor6geral)];
            minmax.minmax_maior6alto = [Math.min.apply(null, minmax.maior6alto), Math.max.apply(null, minmax.maior6alto)];
            minmax.minmax_maior6medio = [Math.min.apply(null, minmax.maior6medio), Math.max.apply(null, minmax.maior6medio)];
            minmax.minmax_maior6baixo = [Math.min.apply(null, minmax.maior6baixo), Math.max.apply(null, minmax.maior6baixo)];
            minmax.minmax_total = [Math.min.apply(null, minmax.total), Math.max.apply(null, minmax.total)];
            $scope.minmax = minmax;
        };

        $scope.obterCor = function (id_agrupamento, value, min, max) {
            if (id_agrupamento > 0) {
                value = value.replace('%', '').replace('.', '').replace(',', '.');
                let percent = (value - min) / (max - min);
                var hue = ((percent) * 120).toString(10);
                return ["hsl(", hue, ",100%,50%)"].join("");
            }
        };

        $scope.carregarBaixas = function () {
            let dados = $scope.dashboard.dados.filter(o => o.id_piloto == $scope.dashboard.opt.lote && o.atual);

            // aplicar filtros
            let filtro_agrupamento = $scope.dashboard.opt.filtro_agrupamento;
            let filtro_tempocasa = $scope.dashboard.opt.filtro_tempocasa;
            let filtro_risco = $scope.dashboard.opt.filtro_risco;

            if (filtro_agrupamento > 0)
                dados = dados.filter(o => o.id_agrupamento == filtro_agrupamento);
            if (filtro_tempocasa > 0)
                dados = dados.filter(o => o.id_tempocasa == filtro_tempocasa);
            if (filtro_risco > 0) 
                dados = dados.filter(o => o.id_risco == filtro_risco);

            // ## BAIXAS ##

            // == tempo de casa ==
            let tempocasa = alasql('select tempocasa, sum(contas) contas, sum(contas)-sum(estoque) baixas from ? group by tempocasa', [dados]);
            $scope.dashboard.baixa_tempocasa = {
                title: {
                    text: undefined,
                },
                xAxis: {
                    categories: [...new Set(dados.map(o => o.tempocasa))]
                },
                yAxis: [
                     { visible: false },
                     { min: 0, max: 100, opposite: true, visible: false }
                ],
                plotOptions: {
                    spline: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                series: [
                    {
                        name: 'Contas',
                        type: 'column',
                        data: tempocasa.map(obj => obj.contas),
                    },
                    {
                        name: 'Baixas',
                        type: 'column',
                        data: tempocasa.map(obj => obj.baixas),
                    },
                    {
                        name: '% Baixado',
                        type: 'spline',
                        yAxis: 1,
                        data: tempocasa.map(obj => (obj.baixas * 100.0 / obj.contas).toFixed(1) / 1),
                    }
                ],
                credits: {
                    enabled: false
                }
            }


            // == risco ==
            let risco = alasql('select risco, sum(contas) contas, sum(contas)-sum(estoque) baixas from ? group by risco', [dados]);
            $scope.dashboard.baixa_risco = {
                title: {
                    text: undefined,
                },
                xAxis: {
                    categories: [...new Set(dados.map(o => o.risco))]
                },
                yAxis: [
                     { visible: false },
                     { min: 0, max: 100, opposite: true, visible: false }
                ],
                plotOptions: {
                    spline: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                series: [
                    {
                        name: 'Contas',
                        type: 'column',
                        data: risco.map(obj => obj.contas),
                    },
                    {
                        name: 'Baixas',
                        type: 'column',
                        data: risco.map(obj => obj.baixas),
                    },
                    {
                        name: '% Baixado',
                        type: 'spline',
                        yAxis: 1,
                        data: risco.map(obj => (obj.baixas * 100.0 / obj.contas).toFixed(1) / 1),
                    }
                ],
                credits: {
                    enabled: false
                }
            }

            let agrupamento = alasql('select agrupamento, sum(contas) contas, sum(contas)-sum(estoque) baixas from ? group by agrupamento', [dados]);
            $scope.dashboard.agrupamento = [...new Set(agrupamento.map(o => o.agrupamento))];
            $scope.dashboard.baixa_agrupamento = [{ name: '% Baixado', data: agrupamento.map(obj => (obj.baixas * 100.0 / obj.contas).toFixed(1) / 1) }];
        };

        $scope.carregarDashboard();
    });
</script>
