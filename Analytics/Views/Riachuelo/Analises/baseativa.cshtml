@{
    Layout = "~/Views/master.cshtml";
}
<!-- DAHSBOARD -->

<div ng-controller="ctrl-riachuelo-analise">
    <div ng-if="dashboard.status == 200">
        <div class="box box-widget widget-user">
            <div class="widget-user-header bg-black" style="background: url('/Content/Images/Riachuelo/Banner.jpg') center center;">
            </div>
         </div>

            <div class="row margin-bottom">
                <div class="col-xs-12">

                    <!--VALOR-->
                    <div class="col-xs-12 col-md-12">
                        <h3 class="text-center">Faixa Valor</h3>
                        <high-chart series="dashboard.valor" axis-Categories="dashboard.faixaValor" plot-Options-Column-Data-Label="true" type="column"></high-chart>
                    </div>

                    <!--GRUPOS-->
                    <div class="col-xs-12 col-md-6">
                        <h3 class="text-center">Grupos</h3>
                        <high-chart series="dashboard.grupo" axis-Categories="dashboard.faixaGrupo" plot-Options-Bar-Data-Label="true" type="bar"></high-chart>
                    </div>

                    <!--LOCALIZACAO-->
                    <div class="col-xs-12 col-md-6">
                        <h3 class="text-center">Localização</h3>
                        <mapa-brasil style="height:400px" width="100%" dados="dashboard.mapa"></mapa-brasil>
                    </div>

                    <!--POR FAIXA DE ATRASO-->
                    <div class="col-xs-12">
                        <h3 class="text-center">Faixa de Atraso</h3>
                        <high-chart series="dashboard.atraso" axis-Categories="dashboard.faixaAtraso" plot-Options-Line-Data-Label="true" type="line"></high-chart>
                    </div>

                    <!--VALOR-->
                    <div class="col-xs-12 col-md-12">
                        <h3 class="text-center">Faixa Idade</h3>
                        <high-chart series="dashboard.idade" axis-Categories="dashboard.faixaIdade" plot-Options-Column-Data-Label="true" type="column"></high-chart>
                    </div>

                </div>

                <!-- SIDE BAR CONTROL -->
                <aside class="control-sidebar control-sidebar-dark" ng-if="dashFiltros.status === 200">
                    <!-- Create the tabs -->
                    <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
                        <li class="active"><a data-target="#control-sidebar-filters-tab" data-toggle="tab"><i class="fa fa-filter"></i></a></li>
                    </ul>
                    <!-- Tab panes -->
                    <div class="tab-content">
                        <!-- Filtros -->
                        <div class="tab-pane active" id="control-sidebar-filters-tab">

                            <!--EMPRESA-->
                            <div class="form-group">
                                <label class="control-sidebar-subheading">Empresa</label>
                                <select2 class="form-control" data-placeholder="Selecione" ng-model="filtros.empresa" dados="dashFiltros.empresa"></select2>
                            </div>

                            <!--CARTEIRA-->
                            <div class="form-group">
                                <label class="control-sidebar-subheading">Carteira</label>
                                <select2 class="form-control" data-placeholder="Selecione" ng-model="filtros.carteira" dados="dashFiltros.carteira"></select2>
                            </div>

                            <!--GRUPOS-->
                            <div class="form-group">
                                <label class="control-sidebar-subheading">Grupos</label>
                                <select2 class="form-control" data-placeholder="Selecione" ng-model="filtros.grupo" dados="dashFiltros.grupo"></select2>
                            </div>

                            <!--BOTÃO-->
                            <div class="form-group">
                                <button type="button" class="btn btn-primary" data-toggle="control-sidebar" ng-click="carregarDashboard()">Carregar Dados</button>
                            </div>

                        </div>
                        <!-- /.tab-pane -->
                    </div>
                </aside>

            </div>
        </div>
</div>

<script>
        angular.module('app').controller('ctrl-riachuelo-analise', function ($scope, $http, $filter, $interval, dadosPagina) {
            dadosPagina.titulo = 'Extratificação de Base';
            dadosPagina.descricao = 'Riachuelo'

            // filtros iniciais
            let newdate = new Date();
            let primeiroDiaMes = new Date(newdate.getFullYear(), newdate.getMonth(), 1);

            $scope.filtros = {
                empresa: '',
                carteira: '',
                grupo: ''
            };
            $scope.dashFiltros = {};
            $scope.dashboard = {};

            //carregar os filtros
            $http({
                method: 'GET',
                url: "/api/riachuelo/dashboard/humano/filtros",
            }).then(function success(r) {
                let data = r.data;
                $scope.dashFiltros.status = r.status;
                $scope.dashFiltros.empresa = data.Table;
                $scope.dashFiltros.carteira = data.Table1;
                $scope.dashFiltros.grupo = data.Table2;

            });

            $scope.carregarDashboard = function () {
                $http({
                    method: 'POST',
                    url: "/api/riachuelo/dashboard/humano/baseativa",
                    data: $scope.filtros,
                }).then(function success(r) {
                    $scope.dashboard.status = r.status;
                    let data = r.data;
                    $scope.dashboard.resumo = data.Table[0];

                    $scope.dashboard.faixaAtraso = data.Table1.map(obj => obj.ds_faixaAtraso);
                    $scope.dashboard.faixaIdade = data.Table2.map(obj => obj.ds_faixaIdade);
                    $scope.dashboard.faixaValor = data.Table3.map(obj => obj.ds_faixaSaldo);
                    $scope.dashboard.faixaGrupo = data.Table5.map(obj => obj.GRUPO);
                    

                    let indicador = 'CONTRATO';

                    $scope.dashboard.atraso = [{ name: [indicador], data: data.Table1.map(obj => (obj[indicador])) }];
                    $scope.dashboard.idade = [{ name: [indicador], data: data.Table2.map(obj => (obj[indicador])) }];
                    $scope.dashboard.valor = [{ name: [indicador], data: data.Table3.map(obj => (obj[indicador])) }];
                    $scope.dashboard.mapa = data.Table4.map(obj => ({ id: 'BR-' + obj.ds_estado, value: obj[indicador] }));
                    $scope.dashboard.grupo = [{ name: [indicador], data: data.Table5.map(obj => (obj[indicador])) }];


                });
            }

            $scope.carregarDashboard();

        });
</script>
