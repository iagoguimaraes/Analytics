<!DOCTYPE html>
<html>
<head>
    <title>Testando</title>
    <meta charset="utf-8" />

    <link href="../Content/Styles/bootstrap.min.css" rel="stylesheet" />
    <link href="../Content/Styles/datatables.min.css" rel="stylesheet" />

    <script src="../Content/Scripts/jquery.min.js"></script>
    <script src="../Content/Scripts/bootstrap.min.js"></script>
    <script src="../Content/Scripts/angular.min.js"></script>
    <script src="../Content/Scripts/highcharts.js"></script>
    <script src="../Content/Scripts/jquery.dataTables.min.js"></script>

</head>
<body ng-app="app" ng-controller="controller">

    <input type="button" value="Carregar Dados" ng-click="carregarDados()" />

    <div ng-if="response.status === 200">
        <d-table class="table table-striped table-bordered" style="width:100%" dados="response.data.Table"></d-table>
        <pie-chart titulo="Atendimento por Canal" series-name="Qt Atendimento" dados="response.data.Table1"></pie-chart>
        <column-chart titulo="Atendimento por Campanha" series-name="Qt Atendimento" dados="response.data.Table2"></column-chart>
    </div>

    <script>
        angular.module('app', []);
        angular.module('app').controller('controller', function ($scope, $http) {

            $scope.carregarDados = function () {
                $http({
                    method: 'GET',
                    url: "/api/mktzap/dashboard",
                }).then(function success(r) {
                    $scope.response = r;
                }, function error(r) {
                    alert(r.responseText);
                });
            }

        });

        angular.module('app').directive('columnChart', function () {
            return {
                restrict: 'E',
                replace: true,
                scope: {
                    titulo: '@',
                    subtitulo: '@',
                    yAxisTitle: '@',
                    seriesName: '@',
                    dados: '=',
                },
                template: '<div></div>',
                link: function (scope, element) {
                    Highcharts.chart(element[0], {
                        chart: {
                            type: 'column'
                        },
                        title: {
                            text: scope.titulo
                        },
                        subtitle: {
                            text: scope.subtitulo
                        },
                        xAxis: {
                            categories: scope.dados.map(obj => obj[Object.keys(obj)[0]]),
                            crosshair: true
                        },
                        yAxis: {
                            title: {
                                text: scope.yAxisTitle
                            }
                        },
                        series: [{
                            name: scope.seriesName,
                            data: scope.dados.map(obj => obj[Object.keys(obj)[1]])
                        }],
                        plotOptions: {
                            column: {
                                dataLabels: {
                                    enabled: true,
                                    //rotation: 270
                                }
                            }
                        }

                    });
                }
            }
        });
        angular.module('app').directive('pieChart', function () {
            return {
                restrict: 'E',
                replace: true,
                scope: {
                    titulo: '@',
                    subtitulo: '@',
                    dados: '=',
                },
                template: '<div></div>',
                link: function (scope, element) {
                    Highcharts.chart(element[0], {
                        chart: {
                            type: 'pie'
                        },
                        title: {
                            text: scope.titulo
                        },
                        subtitle: {
                            text: scope.subtitulo
                        },
                        series: [{
                            name: scope.seriesName,
                            data: scope.dados.map(obj => ({ 'name': obj[Object.keys(obj)[0]], 'y': obj[Object.keys(obj)[1]] }))
                        }]
                    });
                }
            }
        });
        angular.module('app').directive('dTable', function () {
            return {
                restrict: 'E',
                replace: true,
                scope: {
                    info: '@',
                    paging: '@',
                    searching: '@',
                    dados: '=',
                },
                template: '<table><tfoot></tfoot></table>',
                link: function (scope, element) {
                    $(element[0]).DataTable({
                        destroy: true,
                        info: scope.info,
                        paging: scope.paging,
                        searching: scope.searching,
                        data: scope.dados,
                        language: {
                            url: '/Content/Json/datatables-lang.json'
                        },
                        columns: Object.keys(scope.dados[0]).map(p => ({ title: p, data: p }))
                    });
                }
            }
        });

    </script>
</body>
</html>
