<!DOCTYPE html>
<html>
<head>
    <title>Testando</title>
    <meta charset="utf-8" />

    <link href="../Content/Styles/bootstrap.min.css" rel="stylesheet" />
    <link href="../Content/Styles/datatables.min.css" rel="stylesheet" />
    <link href="../Content/Styles/select2.min.css" rel="stylesheet" />

    <script src="../Content/Scripts/jquery.min.js"></script>
    <script src="../Content/Scripts/bootstrap.min.js"></script>
    <script src="../Content/Scripts/angular.min.js"></script>
    <script src="../Content/Scripts/highcharts.js"></script>
    <script src="../Content/Scripts/jquery.dataTables.min.js"></script>
    <script src="../Content/Scripts/select2.full.min.js"></script>

</head>
<body ng-app="app" ng-controller="controller">

    <div ng-if="dadosFiltros.status === 200">
        <input ng-model="filtros.dtini" type="text" />
        <input ng-model="filtros.dtfim" type="text" />
        <select2 ng-model="filtros.campanhas" dados="dadosFiltros.data.Table"></select2>
        <select2 ng-model="filtros.setores" dados="dadosFiltros.data.Table1"></select2>
        <input type="button" value="Carregar Dados" ng-click="carregarDashboard()" />
    </div>

    {{filtros}}

    <div ng-if="dashboard.status === 200">
        <d-table class="table table-striped table-bordered" style="width:100%" dados="dashboard.data.Table"></d-table>
        <pie-chart titulo="Atendimento por Canal" series-name="Qt Atendimento" dados="dashboard.data.Table1"></pie-chart>
        <column-chart titulo="Atendimento por Campanha" series-name="Qt Atendimento" dados="dashboard.data.Table2"></column-chart>
    </div>

    <script>

        angular.module('app', [], function ($httpProvider) {
            // Use x-www-form-urlencoded Content-Type
            $httpProvider.defaults.headers.post['Content-Type'] = 'application/x-www-form-urlencoded;charset=utf-8';
            // Override $http service's default transformRequest
            $httpProvider.defaults.transformRequest = [function (data) {
                return angular.isObject(data) && String(data) !== '[object File]' ? $.param(data) : data;
            }];
        });

        angular.module('app').controller('controller', ['$scope', '$http', 'service', function ($scope, $http, service) {

            $scope.filtros = {};
            $scope.filtros2 = { dtini: "2017-09-01", dtfim: "2017-09-20", campanhas: [{ id: 267 }, { id: 15 }], setores: ["75", "268"] };

            console.log(service.arrayToObject($scope.filtros2.setores));

            $http({
                method: 'GET',
                url: "/api/mktzap/filtros",
            }).then(function success(r) {
                $scope.dadosFiltros = r;
            }, function error(r) {
                alert(r.data.Message);
            });


            $scope.carregarDashboard = function () {
                $http({
                    method: 'POST',
                    url: "/api/mktzap/dashboard",
                    data: $scope.filtros2,
                }).then(function success(r) {
                    $scope.dashboard = r;
                }, function error(r) {
                    alert(r.data.Message);
                });
            }
        }]);

        angular.module('app').directive('columnChart', function () {
            return {
                restrict: 'E',
                replace: true,
                scope: {
                    titulo: '@',
                    subtitulo: '@',
                    yAxisTitle: '@',
                    seriesName: '@',
                    dados: '=',
                },
                template: '<div></div>',
                link: function (scope, element) {
                    Highcharts.chart(element[0], {
                        chart: {
                            type: 'column'
                        },
                        title: {
                            text: scope.titulo
                        },
                        subtitle: {
                            text: scope.subtitulo
                        },
                        xAxis: {
                            categories: scope.dados.map(obj => obj[Object.keys(obj)[0]]),
                            crosshair: true
                        },
                        yAxis: {
                            title: {
                                text: scope.yAxisTitle
                            }
                        },
                        series: [{
                            name: scope.seriesName,
                            data: scope.dados.map(obj => obj[Object.keys(obj)[1]])
                        }],
                        plotOptions: {
                            column: {
                                dataLabels: {
                                    enabled: true,
                                    //rotation: 270
                                }
                            }
                        }

                    });
                }
            }
        });
        angular.module('app').directive('pieChart', function () {
            return {
                restrict: 'E',
                replace: true,
                scope: {
                    titulo: '@',
                    subtitulo: '@',
                    dados: '=',
                },
                template: '<div></div>',
                link: function (scope, element) {
                    Highcharts.chart(element[0], {
                        chart: {
                            type: 'pie'
                        },
                        title: {
                            text: scope.titulo
                        },
                        subtitle: {
                            text: scope.subtitulo
                        },
                        series: [{
                            name: scope.seriesName,
                            data: scope.dados.map(obj => ({ 'name': obj[Object.keys(obj)[0]], 'y': obj[Object.keys(obj)[1]] }))
                        }]
                    });
                }
            }
        });
        angular.module('app').directive('dTable', function () {
            return {
                restrict: 'E',
                replace: true,
                scope: {
                    info: '@',
                    paging: '@',
                    searching: '@',
                    dados: '=',
                },
                template: '<table><tfoot></tfoot></table>',
                link: function (scope, element) {
                    $(element[0]).DataTable({
                        destroy: true,
                        info: scope.info,
                        paging: scope.paging,
                        searching: scope.searching,
                        data: scope.dados,
                        language: {
                            url: '/Content/Json/datatables-lang.json'
                        },
                        columns: Object.keys(scope.dados[0]).map(p => ({ title: p, data: p }))
                    });
                }
            }
        });
        angular.module('app').directive('select2', function () {
            return {
                restrict: 'E',
                replace: true,
                scope: {
                    dados: '=',
                },
                template: '<select class="select2" multiple="multiple"></select>',
                link: function (scope, element) {
                    $(element[0]).select2({
                        data: scope.dados.map(obj => ({ 'id': obj[Object.keys(obj)[0]], 'text': obj[Object.keys(obj)[1]] }))
                    });
                }
            }
        });

        angular.module('app').service('service', function () {
            this.stringify = function (input) {
                let _input = input;
                for (var property in _input) {
                    if (_input.hasOwnProperty(property)) {
                        _input[property] = JSON.stringify(_input[property]);
                    }
                }
                return JSON.stringify(_input);
            }
            this.arrayToObject = function(array){
                return array.map(obj => ({id:obj}));
            }
        });



    </script>
</body>
</html>
